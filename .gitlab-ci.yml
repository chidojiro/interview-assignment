stages:
  - build

build:
  stage: build
  allow_failure: false
  only:
    - main
  tags:
    - randstad-bluex
  script: |
    npm install
    npm run build
    tmp=$(mktemp -d)
    project_root=$(pwd)
    # clone codecommit repo or init new if branch does not exists
    AWS_PROFILE="bluex-codecommit" git clone -b $CI_COMMIT_REF_NAME https://git-codecommit.eu-west-1.amazonaws.com/v1/repos/git-df-prd-bluex-lib-react-components "${tmp}" || (cd ${tmp} && git init && git checkout -b $CI_COMMIT_REF_NAME && git remote add origin https://git-codecommit.eu-west-1.amazonaws.com/v1/repos/git-df-prd-bluex-lib-react-components)
    # remove all except .git in target
    (mv ${tmp}/.git .git.build && rm -rf ${tmp} && mkdir -p ${tmp} && mv .git.build ${tmp}/.git)
    mv build ${tmp}/
    cd ${tmp}
    git add -A
    git commit --allow-empty -m "Autogenerated code at $(date)"
    AWS_PROFILE="bluex-codecommit" git push origin HEAD:refs/heads/$CI_COMMIT_REF_NAME
    # we now need to push only to bx region
    git remote set-url origin https://git-codecommit.eu-west-1.amazonaws.com/v1/repos/git-bluex-prd-bx-lib-react-components
    git push origin HEAD:refs/heads/$CI_COMMIT_REF_NAME

    cd ${project_root}
    rm -rf ${tmp}
