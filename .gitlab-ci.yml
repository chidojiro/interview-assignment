stages:
  - build

build:
  stage: build
  allow_failure: false
  only:
    - dev
    - test
    - ppr
    - prod
  tags:
    - randstad-bluex
  script: |
    npm install
    npm run build
    tmp=$(mktemp -d)
    project_root=$(pwd)
    # clone codecommit repo or init new if branch does not exists
    git clone -b $CI_COMMIT_REF_NAME https://git-codecommit.eu-west-1.amazonaws.com/v1/repos/git-df-prd-bluex-lib-react-components "${tmp}" || (cd ${tmp} && git init && git checkout -b $CI_COMMIT_REF_NAME && git remote add origin https://git-codecommit.eu-west-1.amazonaws.com/v1/repos/git-df-prd-bluex-lib-react-components)
    # remove all except .git in target
    (mv ${tmp}/.git .git.build && rm -rf ${tmp} && mkdir -p ${tmp} && mv .git.build ${tmp}/.git)
    mv build ${tmp}/
    cd ${tmp}
    git add -A
    git commit --allow-empty -m "Autogenerated code at $(date)"
    git push origin HEAD:refs/heads/$CI_COMMIT_REF_NAME

    git remote set-url origin https://git-codecommit.eu-west-1.amazonaws.com-new/v1/repos/git-bluex-prd-bx-lib-react-components
    git push origin HEAD:refs/heads/$CI_COMMIT_REF_NAME

    git remote set-url origin https://git-codecommit.ap-southeast-1.amazonaws.com/v1/repos/git-bluex-prd-bs-lib-react-components
    git push origin HEAD:refs/heads/$CI_COMMIT_REF_NAME

    git remote set-url origin https://git-codecommit.ap-southeast-2.amazonaws.com/v1/repos/git-bluex-prd-ba-lib-react-components
    git push origin HEAD:refs/heads/$CI_COMMIT_REF_NAME

    git remote set-url origin https://git-codecommit.us-east-1.amazonaws.com/v1/repos/git-bluex-prd-bu-lib-react-components
    git push origin HEAD:refs/heads/$CI_COMMIT_REF_NAME

    git remote set-url origin https://git-codecommit.ca-central-1.amazonaws.com/v1/repos/git-bluex-prd-bc-lib-react-components
    git push origin HEAD:refs/heads/$CI_COMMIT_REF_NAME

    cd ${project_root}
    rm -rf ${tmp}
